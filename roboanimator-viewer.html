<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Roboanimator • CSV Viewer (Projection Layout)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- libs -->
  <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root { --bg:#0f1116; --card:#151824; --text:#e8e9ee; --muted:#9aa0ad; --accent:#3ea6ff; --line:#23283a; }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text); font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    header{ padding:18px 20px; border-bottom:1px solid var(--line); display:flex; align-items:center; gap:12px; }
    header h1{ font-size:18px; margin:0; letter-spacing:.2px }
    .wrap{ max-width:1200px; margin:0 auto; padding:18px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:14px; padding:14px; margin-bottom:16px; }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:end; }
    label{ display:block; font-weight:600; margin-bottom:6px; color:#c7cbe2 }
    input[type="number"], input[type="text"]{ width:140px; padding:8px 10px; border-radius:10px; border:1px solid #32384f; background:#0b0d14; color:var(--text); }
    input[type="file"]{ padding:6px 0; color:var(--text) }
    button{ height:38px; padding:0 14px; border-radius:10px; border:1px solid #2b3147; background:#141a2a; color:var(--text); font-weight:600; cursor:pointer }
    button.primary{ background:var(--accent); border-color:#2a6aa0; color:#081019 }
    button:disabled{ opacity:.5; cursor:not-allowed }
    .hint{ color:var(--muted); font-size:.9rem }
    #status{ margin-top:6px; font-size:.95rem }
    .ok{ color:#62ffa5 } .err{ color:#ff6b6b }
    .plot{ height:380px }
  </style>
</head>
<body>
  <header>
    <h1>Roboanimator • CSV Viewer</h1>
    <div class="hint">Visualize CSV logs from the Blender add-on.</div>
  </header>

  <div class="wrap">
    <div class="card">
      <div class="row">
        <div>
          <label for="file">CSV file</label>
          <input id="file" type="file" accept=".csv" />
        </div>
        <div>
          <label for="skiprows">skiprows</label>
          <input id="skiprows" type="number" min="0" value="2" />
          <div class="hint">Top lines to ignore (metadata). Default: 2.</div>
        </div>
        <div>
          <label for="radius">Tire radius (m)</label>
          <input id="radius" type="number" min="0" step="0.001" placeholder="optional" />
          <div class="hint">Blank = speed in average RPM.</div>
        </div>
        <div>
          <button id="render" class="primary" disabled>Parse & Render</button>
        </div>
      </div>
      <div id="status"></div>
    </div>

    <div class="card">
      <div id="speedPlot" class="plot"></div>
      <div id="xyPlot" class="plot"></div>
    </div>

    <div class="card">
      <div id="xyzPlot" style="height:500px"></div>
    </div>
  </div>

<script>
(() => {
  const REQUIRED = ["t","x_m","y_m","rateR_rpm","rateL_rpm"];
  const $ = id => document.getElementById(id);
  const elFile = $("file"), elBtn = $("render"), elSkip = $("skiprows"), elRad = $("radius"), elStatus = $("status");

  let file = null, current = null;

  elFile.addEventListener("change", e => {
    file = e.target.files?.[0] || null;
    elBtn.disabled = !file;
    setStatus(file ? `Selected: ${file.name}` : "");
  });

  elBtn.addEventListener("click", () => {
    if (!file) return;
    parseAndRender();
  });

  function setStatus(msg, kind){
    elStatus.className = kind === "ok" ? "ok" : kind === "err" ? "err" : "";
    elStatus.textContent = msg || "";
  }

  function parseAndRender(){
    setStatus("Parsing…");
    Papa.parse(file, {
      worker: true,
      skipEmptyLines: true,
      complete: (res) => {
        try {
          const rows = res.data;
          if (!rows?.length) return setStatus("Empty CSV","err");
          const sliced = rows.slice(Math.max(0, Number(elSkip.value||0)));

          let header = sliced[0].map(s=>String(s).trim());
          const looksLikeHeader = arr => REQUIRED.every(k=>arr.includes(k));
          if (!looksLikeHeader(header)) return setStatus("Header not found.","err");
          const idx = Object.fromEntries(header.map((h,i)=>[h,i]));
          const dataRows = sliced.slice(1);
          const num=v=>{const n=Number(v);return Number.isFinite(n)?n:NaN};
          const col=name=>dataRows.map(r=>num(r[idx[name]]));
          const t=col("t"), x=col("x_m"), y=col("y_m"), rR=col("rateR_rpm"), rL=col("rateL_rpm");

          const clean = t.map((v,i)=>({t:v,x:x[i],y:y[i],rR:rR[i],rL:rL[i]})).filter(o=>Number.isFinite(o.t)&&Number.isFinite(o.x)&&Number.isFinite(o.y));
          if(clean.length<2) return setStatus("Not enough valid rows","err");

          const radius = elRad.value===""?null:Number(elRad.value);
          const toMS=rpm=>(rpm/60)*(2*Math.PI*radius);
          const speed = clean.map(o=> radius? (toMS(o.rR)+toMS(o.rL))/2 : ((o.rR+o.rL)/2));
          const label = radius?"Speed (m/s)":"Speed (avg RPM)";

          current = {t:clean.map(o=>o.t),x:clean.map(o=>o.x),y:clean.map(o=>o.y),speed,label};

          drawSpeed();
          drawXY();
          draw3D();
          setStatus(`OK: ${clean.length} samples, t=[${clean[0].t.toFixed(3)}…${clean.at(-1).t.toFixed(3)}] s`,"ok");
        }catch(e){setStatus("Parse failed","err");}
      }
    });
  }

  function drawSpeed(){
    const {t,speed,label} = current;
    Plotly.newPlot('speedPlot',[{x:t,y:speed,type:'scatter',mode:'lines',line:{width:2},hovertemplate:`t=%{x:.3f}s<br>${label}: %{y:.4f}<extra></extra>`}],
      {title:'Speed vs Time',xaxis:{title:'t (s)'},yaxis:{title:label},margin:{l:50,r:16,t:40,b:40},paper_bgcolor:'transparent',plot_bgcolor:'transparent'},
      {displaylogo:false,responsive:true});
  }

  function drawXY(){
    const {x,y,t,speed,label} = current;
    Plotly.newPlot('xyPlot',[{x,y,type:'scatter',mode:'lines',line:{width:2},hovertemplate:`x=%{x:.3f} m<br>y=%{y:.3f} m<extra></extra>`}],
      {title:'XY Path',xaxis:{title:'X (m)'},yaxis:{title:'Y (m)',scaleanchor:'x',scaleratio:1},margin:{l:50,r:16,t:40,b:40},paper_bgcolor:'transparent',plot_bgcolor:'transparent'},
      {displaylogo:false,responsive:true});
  }

  function draw3D(){
    const {x,y,t,speed,label} = current;
    Plotly.newPlot('xyzPlot',[{x,y,z:speed,type:'scatter3d',mode:'lines',line:{width:5},customdata:t,hovertemplate:`t=%{customdata:.3f}s<br>x=%{x:.3f} m<br>y=%{y:.3f} m<br>${label}: %{z:.3f}<extra></extra>`}],
      {title:'3D Path vs Speed',scene:{xaxis:{title:'X (m)'},yaxis:{title:'Y (m)'},zaxis:{title:label}},margin:{l:0,r:0,t:40,b:0},paper_bgcolor:'transparent'},
      {displaylogo:false,responsive:true});
  }
})();
</script>
</body>
</html>
